<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bol√£o Amigo Secreto</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    
    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #2D1B4E; color: #F5F5F5; }
        h1, h2, h3, .font-display { font-family: 'Fredoka One', cursive; }
        .page-enter { animation: slideIn 0.4s ease-out forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .input-dark { width: 100%; padding: 1rem; border-radius: 0.75rem; background-color: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; outline: none; }
        details > summary { list-style: none; cursor: pointer; }
        details > summary::-webkit-details-marker { display: none; }
        .avatar-img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
        .badge-pago { position: absolute; bottom: -2px; right: -2px; background: #22c55e; color: white; border-radius: 50%; width: 16px; height: 16px; font-size: 10px; display: flex; align-items: center; justify-content: center; border: 2px solid #2D1B4E; }
        input[type="datetime-local"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }
    </style>
</head>
<body class="bg-[#2D1B4E] min-h-screen pb-10">

    <div id="loading" class="fixed inset-0 bg-[#2D1B4E] z-[60] flex items-center justify-center hidden">
        <div class="flex flex-col items-center">
            <div class="animate-spin text-4xl text-yellow-400 mb-4">‚è≥</div>
            <p id="loading-text" class="text-gray-400 text-sm">Carregando...</p>
        </div>
    </div>

    <div id="painel-admin" class="hidden fixed top-0 right-0 p-2 z-50">
        <div class="bg-gray-800 p-3 rounded-xl text-xs shadow-2xl border border-gray-600 flex flex-col gap-2 w-32">
            <p class="text-gray-400 font-bold text-center border-b border-gray-600 pb-1">ADMIN</p>
            <button id="btnAdminRevelar" class="bg-yellow-600 px-2 py-2 rounded text-white hover:bg-yellow-500 font-bold">üèÜ Revelar</button>
            <button onclick="excluirSala()" class="bg-red-900/80 border border-red-500 text-red-300 px-2 py-2 rounded hover:bg-red-900 flex items-center justify-center gap-2">
                <i class="fa-solid fa-trash"></i> Excluir Sala
            </button>
        </div>
    </div>

    <div id="tela-home" class="min-h-screen flex flex-col items-center justify-center p-6 page-enter">
        <div class="text-center mb-8">
            <div class="inline-block bg-yellow-400 p-5 rounded-full mb-4 shadow-[0_0_30px_rgba(250,204,21,0.4)]">
                <i class="fa-solid fa-gift text-4xl text-purple-900"></i>
            </div>
            <h1 class="text-4xl text-yellow-400 mb-2 font-display">Bol√£o Secreto</h1>
            <p class="text-gray-300">Multiplayer Online</p>
        </div>
        
        <div class="w-full max-w-sm space-y-4">
            <button id="btn-retomar" onclick="reconectarSessao()" class="hidden w-full bg-green-500 hover:bg-green-400 text-white font-bold text-xl py-4 rounded-2xl shadow-lg border-2 border-green-400 flex flex-col items-center justify-center gap-1 transition-transform active:scale-95 relative overflow-hidden">
                <div class="flex items-center gap-3"><i class="fa-solid fa-rotate-right"></i> RETOMAR SALA</div>
                <span id="label-retomar" class="text-xs font-normal opacity-90 text-green-100">...</span>
            </button>

            <button onclick="nav('tela-criar')" class="w-full bg-yellow-400 hover:bg-yellow-300 text-purple-900 font-bold text-xl py-4 rounded-2xl shadow-lg flex items-center justify-center gap-3 active:scale-95"><i class="fa-solid fa-plus-circle"></i> CRIAR SALA</button>
            <button onclick="nav('tela-entrar')" class="w-full bg-indigo-800 hover:bg-indigo-700 text-white font-bold text-xl py-4 rounded-2xl shadow-lg border border-indigo-600 flex items-center justify-center gap-3 active:scale-95"><i class="fa-solid fa-user-check"></i> ENTRAR / LOGIN</button>

            <div id="area-logout" class="text-center hidden pt-4">
                <button onclick="sairDaConta()" class="text-red-400 text-xs hover:text-red-300 underline opacity-60 hover:opacity-100">Sair da conta salva</button>
            </div>
        </div>
    </div>

    <div id="tela-criar" class="hidden min-h-screen flex flex-col items-center justify-center p-6 page-enter">
        <h2 class="text-2xl text-yellow-400 font-display mb-6">Criar Sala</h2>
        <div class="w-full max-w-sm bg-white/5 p-6 rounded-3xl border border-white/10 space-y-4">
            <input type="text" id="cNomeEvento" placeholder="Nome do Evento" class="input-dark">
            <input type="text" id="cNomeAdmin" placeholder="Seu Nome (Admin)" class="input-dark">
            
            <div onclick="abrirPersonalizacao('c')" class="flex items-center gap-3 bg-black/20 p-3 rounded-xl cursor-pointer hover:bg-black/30 border border-white/10">
                <div id="preview-avatar-c" class="w-10 h-10 bg-indigo-500 rounded-full flex items-center justify-center text-xl overflow-hidden">üë§</div>
                <span class="text-sm text-gray-300">Escolher Avatar</span>
            </div>

            <div>
                <label class="text-xs text-gray-400 ml-1 uppercase font-bold">Prazo para Palpites</label>
                <input type="datetime-local" id="cDataLimite" class="input-dark text-sm">
            </div>

            <div class="grid grid-cols-2 gap-4">
                <input type="number" id="cQtd" value="5" class="input-dark text-center" placeholder="Pessoas">
                <input type="number" id="cValor" value="10" class="input-dark text-center" placeholder="Valor R$">
            </div>
            
            <div>
                <label class="text-xs text-gray-400 ml-1 uppercase font-bold">Sua Chave PIX (Para receber se ganhar)</label>
                <input type="text" id="cUserPix" placeholder="CPF / Email / Celular" class="input-dark">
            </div>
            
            <button id="btnCriarFinal" class="w-full bg-green-500 hover:bg-green-400 text-white font-bold py-4 rounded-xl mt-4 shadow-lg active:scale-95">GERAR SALA üé≤</button>
            <button onclick="nav('tela-home')" class="w-full text-gray-400 text-sm py-2 hover:text-white">Voltar</button>
        </div>
    </div>

    <div id="tela-entrar" class="hidden min-h-screen flex flex-col items-center justify-center p-6 page-enter">
        <h2 class="text-2xl text-yellow-400 font-display mb-6">Acessar Sala</h2>
        <div class="w-full max-w-sm bg-white/5 p-6 rounded-3xl border border-white/10 space-y-4">
            <div class="text-center text-xs text-gray-400 mb-2">J√° tem cadastro? Digite seu nome igual para logar.</div>
            <input type="text" id="eCodigo" placeholder="C√≥digo da Sala" class="input-dark text-center uppercase text-2xl tracking-widest font-display">
            <input type="text" id="eNome" placeholder="Seu Nome" class="input-dark">

            <div onclick="abrirPersonalizacao('e')" class="flex items-center gap-3 bg-black/20 p-3 rounded-xl cursor-pointer hover:bg-black/30 border border-white/10">
                <div id="preview-avatar-e" class="w-10 h-10 bg-indigo-500 rounded-full flex items-center justify-center text-xl overflow-hidden">üë§</div>
                <span class="text-sm text-gray-300">Escolher Avatar (Novos)</span>
            </div>

            <div>
                <label class="text-xs text-gray-400 ml-1 uppercase font-bold">Sua Chave PIX (Para receber se ganhar)</label>
                <input type="text" id="eUserPix" placeholder="CPF / Email / Celular" class="input-dark">
            </div>

            <button id="btnEntrarFinal" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-4 rounded-xl mt-4 shadow-lg active:scale-95">ENTRAR / LOGAR üöÄ</button>
            <button onclick="nav('tela-home')" class="w-full text-gray-400 text-sm py-2 hover:text-white">Voltar</button>
        </div>
    </div>

    <div id="tela-jogo" class="hidden max-w-md mx-auto p-4 page-enter">
        <div class="flex justify-between items-center mb-4 mt-2">
            <button onclick="voltarAoMenu()" class="text-xs text-gray-400 border border-gray-600 px-3 py-1 rounded-full hover:bg-gray-800"><i class="fa-solid fa-arrow-left"></i> Menu</button>
            <div class="text-xs text-gray-500">Bol√£o Online</div>
        </div>

        <div class="bg-indigo-900/50 p-4 rounded-2xl mb-4 border border-indigo-500/30 relative overflow-hidden">
            <div class="flex justify-between relative z-10">
                <div>
                    <h3 id="dNomeEvento" class="font-bold text-lg text-white">...</h3>
                    <div onclick="copiarCodigo()" class="flex items-center gap-2 bg-black/30 px-3 py-1 rounded-lg cursor-pointer hover:bg-black/50 transition-colors w-fit mt-1">
                        <span id="dCodigo" class="text-yellow-400 font-display text-xl tracking-wider">...</span>
                        <i class="fa-regular fa-copy text-gray-400 text-xs"></i>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-green-400 font-bold text-xl" id="dPremio">R$ 0</div>
                    <div class="text-[10px] text-gray-400 uppercase">Acumulado</div>
                </div>
            </div>
            
            <div class="mt-4 relative z-10">
                <button id="btnCompartilhar" class="hidden w-full bg-indigo-600 hover:bg-indigo-500 py-2 rounded-lg text-xs text-white font-bold flex items-center justify-center gap-2"><i class="fa-brands fa-whatsapp text-lg"></i> Convidar Amigos</button>
            </div>
        </div>

        <div id="status-bar" class="bg-green-500/20 text-green-400 text-center text-sm py-3 rounded-lg mb-4 font-bold border border-green-500/30 flex justify-center items-center gap-2">
            <div id="status-icon" class="animate-pulse">‚è≥</div>
            <div id="status-texto">Carregando...</div>
        </div>

        <div class="flex justify-between items-center mb-4 bg-white/5 p-2 rounded-xl border border-white/5">
            <div class="flex items-center gap-3">
                <div id="meuAvatar" class="w-10 h-10 bg-yellow-400 rounded-full flex items-center justify-center text-purple-900 font-bold text-xl shadow-lg cursor-pointer hover:scale-110 transition-transform overflow-hidden" onclick="abrirPersonalizacao('jogo')"></div>
                <div onclick="abrirPersonalizacao('jogo')" class="cursor-pointer">
                    <p class="text-[10px] text-gray-400 uppercase">Meu Perfil</p>
                    <p id="meuNomeDisplay" class="font-bold text-white leading-none">...</p>
                </div>
            </div>
            <div class="bg-indigo-950 px-3 py-1 rounded-lg border border-indigo-800 text-right">
                <p class="text-[10px] text-gray-400">PAGAMENTO</p>
                <p id="meuStatusPagamento" class="font-bold text-gray-400 text-xs">Pendente üïí</p>
            </div>
        </div>

        <p class="text-[10px] text-center text-gray-500 mb-2 italic">Dica: Toque no seu palpite para editar (se o tempo permitir)</p>

        <div id="lista-participantes" class="space-y-3 pb-24"></div>
    </div>

    <div id="tela-ranking" class="hidden max-w-md mx-auto p-4 page-enter">
        <div class="text-center mb-6 mt-4">
            <h2 class="text-3xl font-display text-yellow-400">Resultado</h2>
        </div>
        
        <div id="area-vencedor-pix" class="bg-green-500/10 border border-green-500/50 p-4 rounded-xl mb-6 text-center hidden">
            <p class="text-xs text-green-300 uppercase mb-1">üëë Pr√™mio para o Campe√£o</p>
            <p class="text-white text-sm mb-2">Chave Pix de <span id="nome-vencedor" class="font-bold">...</span></p>
            <div onclick="copiarPixVencedor()" class="bg-black/40 p-2 rounded text-yellow-400 font-mono text-lg cursor-pointer flex items-center justify-center gap-2">
                <span id="pix-vencedor-chave">...</span> <i class="fa-regular fa-copy"></i>
            </div>
        </div>

        <div id="podio-area" class="flex justify-center items-end gap-2 mb-8 h-40"></div>
        <div id="lista-ranking" class="space-y-3 pb-10"></div>
        <div class="grid grid-cols-2 gap-4">
             <button onclick="voltarAoMenu()" class="w-full py-4 border border-white/20 text-gray-400 rounded-xl hover:bg-white/5">Menu</button>
             <button onclick="location.reload()" class="w-full py-4 border border-white/20 text-gray-400 rounded-xl hover:bg-white/5">Atualizar</button>
        </div>
    </div>

    <div id="modal-selecao" class="fixed inset-0 bg-black/80 hidden z-50 flex items-end justify-center">
        <div class="bg-gray-900 w-full max-w-md rounded-t-3xl p-6 animate-[slideUp_0.3s_ease-out]">
            <div class="flex justify-between mb-4"><h3 class="text-white font-bold">Quem ele(a) tirou?</h3><button onclick="document.getElementById('modal-selecao').classList.add('hidden')" class="text-gray-400 text-xl">&times;</button></div>
            <div id="grid-opcoes" class="grid grid-cols-4 gap-4"></div>
        </div>
    </div>

    <div id="modal-personalizar" class="fixed inset-0 bg-black/90 hidden z-[70] flex items-center justify-center p-4">
        <div class="bg-gray-800 w-full max-w-sm rounded-2xl p-6 border border-white/10 relative">
            <button onclick="document.getElementById('modal-personalizar').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-white">&times;</button>
            <h3 class="text-xl font-bold text-yellow-400 mb-4 text-center">Avatar</h3>
            <div class="flex justify-center mb-6"><div id="temp-avatar-preview" class="w-24 h-24 rounded-full border-4 border-indigo-500 flex items-center justify-center text-4xl bg-indigo-600 shadow-xl overflow-hidden relative">üë§<div id="loading-upload" class="hidden absolute inset-0 bg-black/50 flex items-center justify-center"><div class="animate-spin text-white">‚è≥</div></div></div></div>
            <p class="text-xs text-gray-400 uppercase mb-2">Op√ß√£o 1: Foto / C√¢mera</p>
            <label class="w-full bg-indigo-600 hover:bg-indigo-500 text-white text-sm font-bold py-3 rounded-xl flex items-center justify-center gap-2 cursor-pointer mb-4 transition-colors"><i class="fa-solid fa-camera"></i> Tirar Foto ou Galeria<input type="file" id="input-file-avatar" class="hidden" accept="image/*" onchange="processarImagem(this)"></label>
            <p class="text-xs text-gray-400 uppercase mb-2">Op√ß√£o 2: Emojis</p>
            <div class="grid grid-cols-5 gap-2 mb-4" id="grid-emojis"></div>
            <p class="text-xs text-gray-400 uppercase mb-2">Cor de Fundo</p>
            <div class="flex justify-between gap-2 mb-6" id="grid-cores"></div>
            <button onclick="salvarPersonalizacao()" class="w-full bg-green-500 hover:bg-green-400 text-white font-bold py-3 rounded-xl shadow-lg">SALVAR</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc, arrayUnion, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // CHAVES FIREBASE:
        const firebaseConfig = {
            apiKey: "AIzaSyBenlc9jAuGq1zsbXuraG40Vzu0bu3PT0g",
            authDomain: "bolao-secreto.firebaseapp.com",
            projectId: "bolao-secreto",
            storageBucket: "bolao-secreto.firebasestorage.app",
            messagingSenderId: "686832695980",
            appId: "1:686832695980:web:d88b70dea07b1e3f08bd09"
        };

        let app, db;
        try { app = initializeApp(firebaseConfig); db = getFirestore(app); console.log("Firebase OK"); } 
        catch (e) { alert("Erro config Firebase"); }

        let dadosSala = null;
        let meuId = null; 
        let meuNome = null;
        let codigoSala = null;
        let unsubscribe = null; 
        let tempAvatar = { tipo: 'emoji', valor: 'üë§', cor: 'bg-indigo-600' };
        let origemPersonalizacao = '';
        let timerInterval = null;

        window.addEventListener('load', () => {
            const sessao = localStorage.getItem('bolao_sessao');
            if(sessao) {
                const dados = JSON.parse(sessao);
                document.getElementById('btn-retomar').classList.remove('hidden');
                document.getElementById('label-retomar').innerText = `Como: ${dados.nome}`;
                document.getElementById('area-logout').classList.remove('hidden');
            }
        });

        // --- EXCLUIR SALA ---
        window.excluirSala = async () => {
            if(confirm("‚ö†Ô∏è TEM CERTEZA? \nIsso apagar√° a sala permanentemente.")) {
                try {
                    await deleteDoc(doc(db, "salas", codigoSala));
                    alert("Sala exclu√≠da.");
                    window.sairDaConta();
                } catch(e) { alert("Erro ao excluir."); }
            }
        }

        // --- CRON√îMETRO INTELIGENTE ---
        function atualizarCronometro() {
            if(!dadosSala || dadosSala.status === 'REVELADO') return;
            const agora = Date.now();
            const prazo = dadosSala.prazo || 0;
            const diff = prazo - agora;
            const statusTexto = document.getElementById('status-texto');
            const statusIcon = document.getElementById('status-icon');
            const statusBar = document.getElementById('status-bar');

            if (diff <= 0) {
                statusTexto.innerText = "Tempo Esgotado! üõë"; statusIcon.innerText = "üîí";
                statusBar.className = "bg-red-500/20 text-red-400 text-center text-sm py-3 rounded-lg mb-4 font-bold border border-red-500/30 flex justify-center gap-2";
                return;
            }

            if (dadosSala.status === 'PALPITES') {
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                
                let display = days > 0 ? `Encerra em: ${days} dias, ${hours}h ${minutes}m` : `Encerra em: ${hours}h ${minutes}m ${seconds}s`;
                statusTexto.innerText = display; statusIcon.innerText = "‚è≥";
                statusBar.className = "bg-green-500/20 text-green-400 text-center text-sm py-3 rounded-lg mb-4 font-bold border border-green-500/30 flex justify-center gap-2";
            }
        }

        // --- COMPRESSOR ---
        window.processarImagem = (input) => {
            const file = input.files[0];
            if (!file) return;
            document.getElementById('loading-upload').classList.remove('hidden');
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.src = e.target.result;
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const maxWidth = 300;
                    const scaleSize = maxWidth / img.width;
                    canvas.width = maxWidth;
                    canvas.height = img.height * scaleSize;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.6);
                    tempAvatar.tipo = 'imagem';
                    tempAvatar.valor = dataUrl;
                    atualizarPreviewUI();
                    document.getElementById('loading-upload').classList.add('hidden');
                }
            }
            reader.readAsDataURL(file);
        };

        // --- ENTRAR (SALVA PIX) ---
        document.getElementById('btnEntrarFinal').addEventListener('click', async () => {
            const codigo = document.getElementById('eCodigo').value.trim().toUpperCase();
            const nome = document.getElementById('eNome').value.trim();
            const pix = document.getElementById('eUserPix').value.trim();
            
            if(!codigo || !nome || !pix) return alert("Preencha todos os campos e sua chave PIX!");
            mostrarLoading(true, "Verificando...");
            const docRef = doc(db, "salas", codigo);
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const dados = docSnap.data();
                    const userExistente = dados.participantes.find(p => p.nome.toUpperCase() === nome.toUpperCase());
                    if(userExistente) {
                        if(confirm(`Ol√° ${userExistente.nome}! Entrar na conta existente?`)) {
                            entrarNaSala(codigo, userExistente.id, userExistente.nome);
                        } else { mostrarLoading(false); alert("Nome em uso."); }
                    } else {
                        if (dados.participantes.length >= dados.qtdMax) { mostrarLoading(false); return alert("Sala cheia!"); }
                        const novoId = dados.participantes.length;
                        const novoUser = { id: novoId, nome: nome, palpites: {}, avatar: tempAvatar, pago: false, pix: pix };
                        await updateDoc(docRef, { participantes: arrayUnion(novoUser) });
                        entrarNaSala(codigo, novoId, nome);
                    }
                } else { mostrarLoading(false); alert("Sala n√£o encontrada!"); }
            } catch(e) { mostrarLoading(false); alert("Erro: " + e.message); }
        });

        // --- CRIAR (SALVA PIX ADMIN) ---
        document.getElementById('btnCriarFinal').addEventListener('click', async () => {
            const nome = document.getElementById('cNomeEvento').value;
            const admin = document.getElementById('cNomeAdmin').value;
            const qtd = parseInt(document.getElementById('cQtd').value);
            const valor = parseFloat(document.getElementById('cValor').value);
            const dataLimite = document.getElementById('cDataLimite').value;
            const pix = document.getElementById('cUserPix').value;

            if(!nome || !admin || !dataLimite || !pix) return alert("Preencha tudo!");
            mostrarLoading(true);

            const prazoTimestamp = new Date(dataLimite).getTime();
            const codigo = Math.random().toString(36).substring(2, 8).toUpperCase();
            let gabarito = {};
            for(let i=0; i<qtd; i++) gabarito[i] = (i === qtd-1) ? 0 : i+1;

            const adminUser = { id: 0, nome: admin, palpites: {}, avatar: tempAvatar, pago: false, pix: pix };

            try {
                await setDoc(doc(db, "salas", codigo), {
                    admin, nomeEvento: nome, qtdMax: qtd, valor,
                    prazo: prazoTimestamp,
                    status: "PALPITES", gabarito,
                    participantes: [adminUser]
                });
                entrarNaSala(codigo, 0, admin);
            } catch (error) { mostrarLoading(false); alert("Erro: " + error.message); }
        });

        const emojisList = ["üéÖ", "ü§∂", "ü¶å", "‚õÑ", "üéÅ", "üéÑ", "üëΩ", "ü¶Ñ", "üê∂", "üê±", "ü¶Å", "üêº", "üòé", "ü§†", "ü§ñ", "üëª", "üí©", "üíÄ", "ü§°", "üëπ"];
        const coresList = ["bg-red-500", "bg-green-500", "bg-blue-500", "bg-purple-600", "bg-yellow-500", "bg-pink-500", "bg-gray-600"];
        window.abrirPersonalizacao = (origem) => {
            origemPersonalizacao = origem;
            const gridEmojis = document.getElementById('grid-emojis'); gridEmojis.innerHTML = '';
            emojisList.forEach(e => gridEmojis.innerHTML += `<div onclick="setTempEmoji('${e}')" class="cursor-pointer text-2xl hover:scale-125 transition-transform text-center select-none">${e}</div>`);
            const gridCores = document.getElementById('grid-cores'); gridCores.innerHTML = '';
            coresList.forEach(c => gridCores.innerHTML += `<div onclick="setTempCor('${c}')" class="w-8 h-8 rounded-full ${c} cursor-pointer hover:scale-110 border-2 border-white/20"></div>`);
            document.getElementById('modal-personalizar').classList.remove('hidden');
        }
        window.setTempEmoji = (e) => { tempAvatar.tipo = 'emoji'; tempAvatar.valor = e; atualizarPreviewUI(); }
        window.setTempCor = (c) => { tempAvatar.cor = c; atualizarPreviewUI(); }
        window.atualizarPreviewUrl = (u) => { if(u.length > 5) { tempAvatar.tipo = 'imagem'; tempAvatar.valor = u; atualizarPreviewUI(); } }
        function atualizarPreviewUI() {
            const el = document.getElementById('temp-avatar-preview');
            el.className = `w-24 h-24 rounded-full border-4 border-white flex items-center justify-center text-4xl shadow-xl overflow-hidden relative ${tempAvatar.cor}`;
            const loader = `<div id="loading-upload" class="hidden absolute inset-0 bg-black/50 flex items-center justify-center"><div class="animate-spin text-white">‚è≥</div></div>`;
            const content = tempAvatar.tipo === 'imagem' ? `<img src="${tempAvatar.valor}" class="avatar-img" onerror="this.src=''">` : tempAvatar.valor;
            el.innerHTML = content + loader;
        }
        window.salvarPersonalizacao = async () => {
            document.getElementById('modal-personalizar').classList.add('hidden');
            if(origemPersonalizacao === 'c') renderMiniAvatar('preview-avatar-c');
            else if (origemPersonalizacao === 'e') renderMiniAvatar('preview-avatar-e');
            else if (origemPersonalizacao === 'jogo' && codigoSala && meuId !== null) {
                try {
                    const novaLista = [...dadosSala.participantes];
                    const idx = novaLista.findIndex(p => p.id === meuId);
                    novaLista[idx].avatar = tempAvatar;
                    await updateDoc(doc(db, "salas", codigoSala), { participantes: novaLista });
                } catch(e) { alert("Erro ao atualizar."); }
            }
        }
        function renderMiniAvatar(id) {
            const el = document.getElementById(id);
            el.className = `w-10 h-10 rounded-full flex items-center justify-center text-xl overflow-hidden ${tempAvatar.cor}`;
            el.innerHTML = tempAvatar.tipo === 'imagem' ? `<img src="${tempAvatar.valor}" class="avatar-img">` : tempAvatar.valor;
        }
        function getAvatarHTML(avObj, size="small") {
            const av = avObj || { tipo: 'emoji', valor: 'üë§', cor: 'bg-indigo-600' };
            const cls = size === "small" ? "w-8 h-8 text-xs" : "w-10 h-10 text-xl";
            const content = av.tipo === 'imagem' ? `<img src="${av.valor}" class="avatar-img">` : av.valor;
            return `<div class="${cls} ${av.cor} rounded-full flex items-center justify-center shadow border border-white/20 overflow-hidden text-white relative">${content}</div>`;
        }

        window.alternarPagamento = async (idAlvo) => {
            if(meuId !== 0) return; 
            const novaLista = [...dadosSala.participantes];
            const idx = novaLista.findIndex(p => p.id === idAlvo);
            novaLista[idx].pago = !novaLista[idx].pago;
            try { await updateDoc(doc(db, "salas", codigoSala), { participantes: novaLista }); }
            catch(e) { alert("Erro ao atualizar pagamento."); }
        }

        function entrarNaSala(codigo, id, nome) {
            codigoSala = codigo; meuId = id; meuNome = nome;
            localStorage.setItem('bolao_sessao', JSON.stringify({ codigo, id, nome }));
            document.getElementById('dCodigo').innerText = codigo;
            mostrarLoading(false);
            window.nav('tela-jogo');
            if(unsubscribe) unsubscribe();
            unsubscribe = onSnapshot(doc(db, "salas", codigo), (doc) => {
                if(doc.exists()) { dadosSala = doc.data(); atualizarTelaJogo(); }
                else { alert("Sala encerrada."); voltarAoMenu(); }
            });
            if(timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(atualizarCronometro, 1000);
        }

        function atualizarTelaJogo() {
            const pagantes = dadosSala.participantes.filter(p => p.pago).length;
            document.getElementById('dNomeEvento').innerText = dadosSala.nomeEvento;
            document.getElementById('dPremio').innerText = `R$ ${(dadosSala.valor * pagantes).toFixed(2)}`;
            
            const eu = dadosSala.participantes.find(p => p.id === meuId);
            if(eu) {
                document.getElementById('meuNomeDisplay').innerText = eu.nome;
                document.getElementById('meuAvatar').innerHTML = getAvatarHTML(eu.avatar, "medium").replace(/w-\d+ h-\d+ text-\w+/, "w-full h-full text-xl");
                document.getElementById('meuAvatar').className = "w-10 h-10 rounded-full flex items-center justify-center shadow-lg cursor-pointer hover:scale-110 transition-transform overflow-hidden";
                const statusEl = document.getElementById('meuStatusPagamento');
                if(eu.pago) { statusEl.innerText = "Confirmado ‚úÖ"; statusEl.className = "font-bold text-green-400 text-xs"; }
                else { statusEl.innerText = "Pendente üïí"; statusEl.className = "font-bold text-yellow-400 text-xs"; }
            }

            if(meuId === 0) {
                document.getElementById('painel-admin').classList.remove('hidden');
                document.getElementById('btnCompartilhar').classList.remove('hidden');
                document.getElementById('btnAdminRevelar').onclick = () => mudarStatus('REVELADO');
            } else {
                document.getElementById('painel-admin').classList.add('hidden');
                document.getElementById('btnCompartilhar').classList.add('hidden');
            }

            if (dadosSala.status === 'REVELADO') {
                calcularEExibirRanking();
                return;
            }
            renderLista();
        }

        function renderLista() {
            const container = document.getElementById('lista-participantes'); container.innerHTML = '';
            const eu = dadosSala.participantes.find(p => p.id === meuId);
            const palpites = eu ? eu.palpites : {};
            let possivel = Math.max(0, dadosSala.participantes.length - 1);
            let feitos = 0;
            for (const [k, v] of Object.entries(palpites)) { if (dadosSala.participantes.some(p => p.id == k)) feitos++; }
            
            const tempoEsgotado = Date.now() > (dadosSala.prazo || 0);
            const bloqueado = tempoEsgotado || dadosSala.status !== 'PALPITES';

            dadosSala.participantes.forEach(p => {
                const pid = palpites[p.id]; 
                const alvo = pid !== undefined ? dadosSala.participantes.find(x => x.id === pid) : null;
                const avHtml = getAvatarHTML(p.avatar, "small");
                let badgePago = p.pago ? `<div class="badge-pago">‚úî</div>` : '';
                let btnAdminPag = '';
                if(meuId === 0) btnAdminPag = `<button onclick="window.alternarPagamento(${p.id})" class="ml-2 text-[10px] px-2 py-1 rounded border ${p.pago ? 'border-green-500 text-green-400 bg-green-900/30' : 'border-gray-500 text-gray-400 bg-gray-800'} hover:bg-white/10 transition-colors">${p.pago ? 'Pago' : 'Validar'}</button>`;

                let htmlPalpite = `<span class="text-2xl text-gray-600">?</span>`;
                if(alvo) {
                    htmlPalpite = `<div class="flex items-center gap-2">${getAvatarHTML(alvo.avatar, "small")} <span class="font-bold text-green-400 truncate text-sm">${alvo.nome}</span>${!bloqueado && p.id === meuId ? '<i class="fa-solid fa-pencil text-gray-500 text-[10px] ml-1"></i>' : ''}</div>`;
                }

                let cls = 'cursor-default opacity-60'; let attr = '';
                if(!bloqueado && p.id !== meuId) { cls = 'cursor-pointer hover:bg-white/10'; attr = `data-id="${p.id}"`; }

                container.innerHTML += `
                    <div class="bg-white/5 border border-white/10 rounded-2xl p-3 flex items-center justify-between transition-all">
                        <div class="flex items-center gap-3 w-1/2 relative">
                            <div class="relative">${avHtml}${badgePago}</div>
                            <div class="flex flex-col"><div class="flex items-center"><span class="font-bold ${p.pago ? 'text-green-200' : 'text-gray-400'} truncate text-sm">${p.nome}</span>${btnAdminPag}</div></div>
                        </div>
                        <div class="text-gray-500">‚ûú</div>
                        <div class="w-1/2 relative group ${cls} card-palpite" ${attr}>
                            <div class="${alvo ? 'bg-green-500/20 border-green-500' : 'bg-dashed border-gray-600'} border-2 border-dashed rounded-xl p-2 flex items-center justify-center gap-2 h-12 transition-all overflow-hidden">${htmlPalpite}</div>
                        </div>
                    </div>`;
            });
            document.querySelectorAll('.card-palpite').forEach(el => { el.addEventListener('click', () => { const id = parseInt(el.getAttribute('data-id')); if(!isNaN(id)) abrirSelecao(id); }); });
        }

        window.abrirSelecao = (id) => {
            const m = document.getElementById('modal-selecao'); const g = document.getElementById('grid-opcoes'); g.innerHTML = '';
            dadosSala.participantes.forEach(p => {
                if(p.id === id) return; 
                const btn = document.createElement('button');
                btn.className = "flex flex-col items-center gap-1 p-2 rounded-xl bg-white/10 hover:bg-white/20 transition-all active:scale-95";
                btn.innerHTML = `${getAvatarHTML(p.avatar, "medium")}<span class="text-xs font-bold text-gray-300 truncate w-full text-center mt-1">${p.nome}</span>`;
                btn.onclick = () => enviarPalpite(id, p.id);
                g.appendChild(btn);
            });
            m.classList.remove('hidden');
        }
        async function enviarPalpite(quem, palpite) {
            document.getElementById('modal-selecao').classList.add('hidden');
            const lista = [...dadosSala.participantes]; const idx = lista.findIndex(p => p.id === meuId);
            if(!lista[idx].palpites) lista[idx].palpites = {}; lista[idx].palpites[quem] = palpite;
            try { await updateDoc(doc(db, "salas", codigoSala), { participantes: lista }); } catch(e) { alert("Erro ao salvar."); }
        }
        async function mudarStatus(s) { try { await updateDoc(doc(db, "salas", codigoSala), { status: s }); } catch(e) { alert("Erro status."); } }
        window.reconectarSessao = async () => {
            const sessao = JSON.parse(localStorage.getItem('bolao_sessao'));
            if(sessao && sessao.codigo) { mostrarLoading(true, "Reconectando..."); try { const docSnap = await getDoc(doc(db, "salas", sessao.codigo)); if(docSnap.exists()) entrarNaSala(sessao.codigo, sessao.id, sessao.nome); else { alert("Sala n√£o encontrada."); window.sairDaConta(); } } catch(e) { mostrarLoading(false); alert("Erro conex√£o."); } }
        };
        window.sairDaConta = () => { if(confirm("Apagar dados?")) { localStorage.removeItem('bolao_sessao'); location.reload(); } };
        window.voltarAoMenu = () => { if(unsubscribe) unsubscribe(); window.nav('tela-home'); };
        window.nav = (t) => { document.querySelectorAll('.page-enter').forEach(el => el.classList.add('hidden')); document.getElementById(t).classList.remove('hidden'); };
        function mostrarLoading(show, txt="...") { document.getElementById('loading').classList.toggle('hidden', !show); document.getElementById('loading-text').innerText = txt; }
        document.getElementById('btnCompartilhar').addEventListener('click', async () => { const txt = `üéÅ Bol√£o Amigo Secreto!\nC√≥digo: *${codigoSala}*\nLink: ${window.location.href}`; if (navigator.share) try { await navigator.share({ title: 'Bol√£o', text: txt, url: window.location.href }); } catch (err) {} else { navigator.clipboard.writeText(txt); alert("Copiado!"); } });
        
        // MOSTRAR PIX DO VENCEDOR
        window.copiarPixVencedor = () => {
            const pix = document.getElementById('pix-vencedor-chave').innerText;
            navigator.clipboard.writeText(pix);
            alert("Chave do Vencedor Copiada!");
        }

        function calcularEExibirRanking() {
            window.nav('tela-ranking'); const c = document.getElementById('lista-ranking'); const podio = document.getElementById('podio-area'); c.innerHTML = '';
            let rk = []; dadosSala.participantes.forEach(p => { let pts = 0; if(p.palpites) { for (const [k, v] of Object.entries(p.palpites)) { if(parseInt(v) === dadosSala.gabarito[k]) pts++; } } rk.push({ nome: p.nome, pontos: pts, palpites: p.palpites, avatar: p.avatar, pix: p.pix }); });
            rk.sort((a,b) => b.pontos - a.pontos);

            // EXIBE PIX DO VENCEDOR
            const vencedor = rk[0];
            if(vencedor && vencedor.pix) {
                document.getElementById('area-vencedor-pix').classList.remove('hidden');
                document.getElementById('nome-vencedor').innerText = vencedor.nome;
                document.getElementById('pix-vencedor-chave').innerText = vencedor.pix;
            }

            podio.innerHTML = `<div class="flex flex-col items-center"><div class="text-3xl mb-1">ü•à</div><div class="bg-gray-400/20 p-2 rounded-t-lg h-24 flex flex-col items-center justify-end font-bold w-20 text-sm text-gray-300 gap-1">${getAvatarHTML(rk[1]?.avatar, "small")}<span>${rk[1]?.nome.split(' ')[0] || '-'}</span></div></div><div class="flex flex-col items-center -mt-4"><div class="text-4xl mb-1">ü•á</div><div class="bg-yellow-400/20 border-2 border-yellow-400 p-2 rounded-t-lg h-32 flex flex-col items-center justify-end font-bold text-yellow-400 w-24 shadow-[0_0_15px_rgba(250,204,21,0.3)] gap-1">${getAvatarHTML(rk[0]?.avatar, "small")}<span>${rk[0]?.nome.split(' ')[0] || '-'}</span></div></div><div class="flex flex-col items-center"><div class="text-3xl mb-1">ü•â</div><div class="bg-orange-700/20 p-2 rounded-t-lg h-16 flex flex-col items-center justify-end font-bold w-20 text-sm text-orange-300 gap-1">${getAvatarHTML(rk[2]?.avatar, "small")}<span>${rk[2]?.nome.split(' ')[0] || '-'}</span></div></div>`;
            rk.forEach((r, idx) => {
                let det = '<div class="mt-4 grid grid-cols-1 gap-2 bg-black/20 p-3 rounded-xl">';
                dadosSala.participantes.forEach(p => { const pf = r.palpites ? r.palpites[p.id] : undefined; const ok = parseInt(pf) === dadosSala.gabarito[p.id]; const chutado = dadosSala.participantes.find(x=>x.id == pf)?.nome || "?"; det += `<div class="flex justify-between text-xs border-b border-white/5 pb-1"><span class="text-gray-400">${p.nome} tirou...</span><span class="${ok?'text-green-400 font-bold':'text-red-400'}">${chutado} ${ok?'‚úÖ':'‚ùå'}</span></div>`; }); det += '</div>';
                c.innerHTML += `<details class="bg-white/5 border border-white/10 rounded-2xl overflow-hidden group"><summary class="p-4 flex items-center justify-between hover:bg-white/5 transition-colors"><div class="flex items-center gap-3"><div class="text-gray-500 font-bold w-6 text-center">${idx+1}¬∫</div>${getAvatarHTML(r.avatar, "small")}<div class="font-bold text-gray-200">${r.nome}</div></div><div class="flex items-center gap-3"><span class="font-bold text-xl text-yellow-400">${r.pontos}</span><div class="text-xs text-gray-500">pts</div></div></summary><div class="px-4 pb-4">${det}</div></details>`;
            });
        }
    </script>
</body>
</html>
